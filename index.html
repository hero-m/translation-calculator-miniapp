<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>نرخ‌نامه ترجمه</title>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <style>
    #rtc-rate-calculate-form {
      margin-top: 100px;
    }

    #rtc-rate-calculate-form input,
    #rtc-rate-calculate-form select {
      margin-bottom: 20px;
    }
    
  </style>
</head>
<body>
  <div class="container">
    <div id="intro">
      <span>نرخ‌نامه‌ی ترجمه، نیمه‌ی دوم سال ۱۴۰۳</span>
      <span>این نرخ‌نامه مطابق با قانون کار ایران و با درنظرگرفتن ساعت کار روزانهٔ مترجمان تنظیم شده است.</span>
    </div>
    <form id="rtc-rate-calculate-form">
      <div>
        <label for="rtc-translation-type" class="form-label">حوزه‌ی ترجمه</label>
        <select id="rtc-translation-type" class="form-control">
          <option value="" selected>گزینه‌ای را انتخاب کنید</option>
          <option value="text">ترجمه‌ی کتبی</option>
          <option value="news">ترجمه‌ی خبر</option>
          <option value="interpret">ترجمه‌ی شفاهی</option>
          <option value="media">ترجمه‌ی رسانه</option>
          <option value="apps">بومی‌سازی وبگاه و اپلیکیشن</option>
        </select>
      </div>
      <div id="rtc-text-parameters" class="rtc-parameter-group" style="display: none">
        <div>
          <label for="rtc-text-translation-type" class="form-label">نوع ترجمه‌ی کتبی</label>
          <select id="rtc-text-translation-type" class="form-control multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="human">ترجمه‌ی انسانی</option>
            <option value="machine">ترجمه‌ی ماشینی</option>
            <option value="analysis">ارزیابی کیفیت ترجمه</option>
            <option value="edit-human">اصلاح ترجمه‌ی انسانی</option>
            <option value="edit-machine">اصلاح ترجمه‌ی ماشینی</option>
            <option value="author">تولید محتوا (جستجو + ترجمه)</option>
          </select>
        </div>
        <div id="rtc-text-translation-skill-parameter">
          <label for="rtc-text-translation-skill" class="form-label">رتبه‌ی مترجم</label>
          <select id="rtc-text-translation-skill" class="form-control rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="level-1">مترجم سطح ۱ (مهارت تجربی کم، دانش فنی کم)</option>
            <option value="level-2">مترجم سطح ۲ (مهارت تجربی کم، دانش فنی قابل‌قبول)</option>
            <option value="level-3">مترجم سطح ۳ (مهارت تجربی قابل‌قبول، دانش فنی کم)</option>
            <option value="level-4">مترجم سطح ۳ (مهارت تجربی قابل‌قبول، دانش فنی قابل‌قبول)</option>
          </select>
        </div>
        <div>
          <label for="rtc-text-translation-speed" class="form-label">زمان تحویل</label>
          <select id="rtc-text-translation-speed" class="form-control rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="regular">عادی (روزانه ۲۵۰۰ کلمه)</option>
            <option value="fast">نیمه‌فوری (روزانه ۳۵۰۰ کلمه)</option>
            <option value="urgent">فوری (روزانه ۵۰۰۰ کلمه)</option>
          </select>
        </div>
        <div>
          <label for="rtc-text-translation-topic" class="form-label">موضوع ترجمه</label>
          <select id="rtc-text-translation-topic" class="form-control rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="general">عمومی</option>
            <option value="engineering">فنی مهندسی</option>
            <option value="executive">اجرایی</option>
            <option value="business">تجاری</option>
            <option value="medical">پزشکی</option>
            <option value="legal">قضایی</option>
            <option value="abstract">نظری فلسفی</option>
            <option value="literature">ادبی</option>
            <option value="other">سایر</option>
          </select>
        </div>
        <div>
          <label for="rtc-text-translation-language" class="form-label">زبان ترجمه</label>
          <select id="rtc-text-translation-language" class="form-select rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="en-to-fa">انگلیسی به فارسی</option>
            <option value="fa-to-en">فارسی به انگلیسی</option>
            <option value="langs1-to-fa">آلمانی، عربی، روسی، ترکی استانبولی، ترکی آذربایجانی، پرتغالی، ایتالیایی، فرانسوی، اسپانیایی، هلندی، تاجیک، سوئدی، هلندی، کردی به فارسی</option>
            <option value="fa-to-langs1">فارسی به آلمانی، عربی، روسی، ترکی استانبولی، ترکی آذربایجانی، پرتغالی، ایتالیایی، فرانسوی، اسپانیایی، هلندی، تاجیک، سوئدی، هلندی، کردی</option>
            <option value="langs2-to-fa">ژاپنی، چینی، اردو، ارمنی، پشتو، دری، تاجیک، رومانیایی، کره‌ای، گرجی، لهستانی، مجاری به فارسی</option>
            <option value="fa-to-langs2">فارسی به ژاپنی، چینی، اردو، ارمنی، پشتو، دری، تاجیک، رومانیایی، کره‌ای، گرجی، لهستانی، مجاری</option>
          </select>
        </div>
      </div>
      <div id="rtc-interpret-parameters" class="rtc-parameter-group" style="display: none">
        <div>
          <label for="rtc-interpret-type" class="form-label">نوع ترجمه‌ی شفاهی</label>
          <select id="rtc-interpret-type" class="form-control rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="simultaneous">همزمان</option>
            <option value="consecutive">پیاپی - همراه</option>
            <option value="remote">تلفنی</option>
          </select>
        </div>
      </div>
      <div id="rtc-media-parameters" class="rtc-parameter-group" style="display: none">
        <div>
          <label for="rtc-media-type" class="form-label">نوع ترجمه‌ی رسانه</label>
          <select id="rtc-media-type" class="form-control multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="only-transcribe">پیاده‌سازی بدون ترجمه</option>
            <option value="only-translate">ترجمه بدون پیاده‌سازی</option>
            <option value="transcribe-translate">پیاده‌سازی و ترجمه</option>
            <option value="translate-subtitles">ترجمه‌ی زیرنویس</option>
          </select>
        </div>
      </div>
      <div id="rtc-common-parameters" class="rtc-parameter-group" style="display: none">
        <div id="rtc-common-language-parameter" class="rtc-parameter-group" style="display: none">
          <label for="rtc-common-language" class="form-label">زبان ترجمه</label>
          <select id="rtc-common-language" class="form-select">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="en-to-fa">انگلیسی به فارسی</option>
            <option value="fa-to-en">فارسی به انگلیسی</option>
          </select>
        </div>
        <div>
          <label for="rtc-common-skill" class="form-label">رتبه‌ی مترجم</label>
          <select id="rtc-common-skill" class="form-control rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="level-1-2">مترجم سطح ۱ و ۲</option>
            <option value="level-3-4">مترجم سطح ۳ و ۴</option>
          </select>
        </div>
        <div>
          <label for="rtc-common-topic" class="form-label">موضوع ترجمه</label>
          <select id="rtc-common-topic" class="form-control rtc-multiplier">
            <option value="" selected>گزینه‌ای را انتخاب کنید</option>
            <option value="general">عمومی</option>
            <option value="special">اختصاصی</option>
          </select>
        </div>
      </div>
      <div id="rtc-work-parameter" class="rtc-parameter-group" style="display: none">
        <label for="rtc-work-amount" class="form-label">حجم کار</label>
        <div class="input-group">
          <input id="rtc-work-amount" class="form-control" type="number" step="1" min="0">
          <div class="input-group-append">
            <label id="rtc-work-unit" class="input-group-text" for="rtc-work-amount"> - </label>
          </div>
        </div>
      </div>
    </form>
    <div id="rtc-result" class="container">
      <div class="row">
        نرخ پایه:
        <span id="rtc-result-base-rate"></span>

      </div>
      <div class="row">
        ضریب:
        <span id="rtc-result-multiplier"></span>

      </div>
      <div class="row">
        نرخ با ضریب:
        <span id="rtc-result-combined-rate"></span>
      </div>

      <div class="row">
        حداقل دستمزد:
        <span id="rtc-result-total-price"></span>
      </div>
    </div>
  </div>

  <script>
    var TRANSLATION_RATES_URLS = [
      'https://hero-m.github.io/translation-calculator-miniapp/rates-1403h2-v1.json',
      'https://motarjemshodan.ir/translation-rates.json'
    ];
    var PREFIX = 'rtc-';
    var CURRENCY = 'تومان';

    var calculator_definitions = {
      work_units: {
        'text': 'کلمه',
        'news': 'مقاله',
        'interpret': 'ساعت',
        'media': {
          'translate_subtitles': 'خط',
          'other': 'دقیقه'
        },
        'apps': 'کلمه'
      },

      baserate_parameters: {
        'text': ['text-translation-type'],
        'news': [],
        'interpret': ['interpret-type', 'common-language'],
        'media': ['media-type', 'common-language'],
        'apps': ['common-language']
      },

      parameter_groups: {
        '': [],
        'text': [PREFIX + 'text-parameters', PREFIX + 'work-parameter'],
        'news': [PREFIX + 'common-parameters', PREFIX + 'work-parameter'],
        'interpret': [PREFIX + 'interpret-parameters', PREFIX + 'common-parameters', PREFIX + 'common-language-parameter', PREFIX + 'work-parameter'],
        'media': [PREFIX + 'media-parameters', PREFIX + 'common-parameters', PREFIX + 'common-language-parameter', PREFIX + 'work-parameter'],
        'apps': [PREFIX + 'common-parameters', PREFIX + 'common-language-parameter', PREFIX + 'work-parameter']
      },

      translation_rates: null,
      multipliers: null
    }

    function rtc_initialize() {
      fetch_translation_rates(0).then(function (result) {
        if (result != null) {
          calculator_definitions.translation_rates = result;
          // _rtctext('form-title', result['last-update']);
          document.getElementById('rtc-translation-type').addEventListener('change', update_translation_type);
          document.getElementById('rtc-text-translation-type').addEventListener('change', update_text_translation_type);
          document.getElementById('rtc-rate-calculate-form').querySelectorAll('select, input').forEach(element => {
            element.addEventListener('change', display_rates);
            element.addEventListener('input', display_rates);
          });

          update_translation_type();
          display_rates();
        }
      });
    }

    function update_translation_type() {
      var translation_type = _rtcval('translation-type');
      document.querySelectorAll('.' + PREFIX + 'parameter-group').forEach(element => {
        if (calculator_definitions.parameter_groups[translation_type].includes(element.id)) {
          element.style.display = '';
        } else {
          element.style.display = 'none';
        }
      });

      if (translation_type == 'text') {
        update_text_translation_type();
      }

      document.getElementById(PREFIX + 'work-amount').value = '';
      if (translation_type != '') {
        _rtctext('work-unit', get_work_unit());
      }
    }

    function update_text_translation_type() {
        var hidettt = ['analysis', 'edit-human', 'edit-machine'].includes(_rtcval('text-translation-type'));
        document.getElementById(PREFIX + 'text-translation-skill-parameter').style.display = hidettt ? 'none' : '';
    }

    function display_rates() {
      var calculated_rates = calculate_rates();

      for (const [key, value] of Object.entries(calculated_rates)) {
        if (value == 0) {
          _rtctext('result-' + key, 'Select more fields');
        } else {
          if (key == 'base-rate') {
            _rtctext('result-base-rate', get_work_unit_per_item() + ' ' + _rtcformat(value, 0) + ' ' + CURRENCY);
          } else if (key == 'multiplier') {
            _rtctext('result-multiplier', '⨯ ' + _rtcformat(value, 2));
          } else if (key == 'combined-rate') {
            _rtctext('result-combined-rate', get_work_unit_per_item() + ' ' + _rtcformat(value, 0) + ' ' + CURRENCY);
          } else if (key == 'total-price') {
            _rtctext('result-total-price', _rtcformat(value, 0) + ' ' + CURRENCY);
          }
        }
      }
    }

    function calculate_rates() {
      var results = {
        'base-rate': 0,
        'multiplier': 0,
        'combined-rate': 0,
        'total-price': 0
      };

      var translation_type = _rtcval('translation-type');
      if (translation_type != '') {
        results['base-rate'] = calculate_base_rate(translation_type);

        if (translation_type == 'text') {
          var multipliers = {...calculator_definitions.translation_rates['multipliers']['text']};
          var hidettt = ['analysis', 'edit-human', 'edit-machine'].includes(_rtcval('text-translation-type'));
          if (hidettt) {
            delete multipliers['text-translation-skill'];
          }
          results['multiplier'] = calculate_multipliers(multipliers);
        } else {
          var multipliers = calculator_definitions.translation_rates['multipliers']['common'];
          results['multiplier'] = calculate_multipliers(multipliers);
        }

        results['combined-rate'] = results['base-rate'] * results['multiplier'];
        results['total-price'] = results['combined-rate'] *  _rtcval('work-amount');
      }

      return results;
    }

    function calculate_base_rate(translation_type) {
      var parameters = calculator_definitions.baserate_parameters;      
      var base_values = calculator_definitions.translation_rates['base-values'];

      var runner = base_values[translation_type];
      for (let i = 0; i < parameters[translation_type].length; i++) {
        var field = parameters[translation_type][i];
        var value = _rtcval(field);
        if (value == '') {
          return 0;
        }

        runner = runner[value];
      }

      return runner;
    }

    function calculate_multipliers(parameters) {
      var result = 1;

      var keys = Object.keys(parameters);
      for (var i = 0; i < keys.length; i++) {
        var choice = _rtcval(keys[i]);
        if (choice == '') {
          return 0;
        }

        var value = parameters[keys[i]][choice];
        if (choice == undefined) {
          return 0;
        }

        result *= value;
      }

      return result;
    }

    function get_work_unit() {
      var units = calculator_definitions.work_units;

      var translation_type = _rtcval('translation-type');
      if (translation_type == 'media') {
        var media_type = _rtcval('media-type');
        if (media_type == 'translate-subtitles') {
          return units['media']['translate_subtitles'];
        }
        
        return units['media']['other'];
      }
      
      return units[translation_type];
    }

    function get_work_unit_per_item() {
      var unit = get_work_unit();

      if (unit[unit.length - 1] == 'ه') {
        return unit + '‌ای';
      } else {
        return unit + 'ی';
      }
    }

    async function fetch_translation_rates(url_index) {
      try {
        const response = await fetch(TRANSLATION_RATES_URLS[url_index]);
        if (!response.ok) {
          throw new Error("Bad network response (status: " + response.status + ")");
        }

        const data = await response.json();
        localStorage.setItem("translation-rates", JSON.stringify(data));
        return data;
      } catch (error) {
        console.error("Error fetching translation rates from '" + TRANSLATION_RATES_URLS[url_index] + "':", error);
        if (url_index < TRANSLATION_RATES_URLS.length - 1) {
          return fetch_translation_rates(url_index + 1);
        } else {
          return JSON.parse(localStorage.getItem("translation-rates"));
        }
      }
    }

    function _rtcformat(number, fraction) {
      return new Intl.NumberFormat('en-US', { maximumFractionDigits: fraction }).format(number);
    }

    function _rtcval(element_id) {
      return document.getElementById(PREFIX + element_id).value;
    }

    function _rtctext(element_id, value) {
      document.getElementById(PREFIX + element_id).textContent = value;
    }

    rtc_initialize();
  </script>
</body>
</html>
